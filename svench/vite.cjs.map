{"version":3,"file":"vite.cjs","sources":["lib/vite-plugin.js"],"sourcesContent":["import Log from './log.js'\nimport { createPluginParts } from './plugin-shared.js'\nimport { createIndex } from './template.js'\nimport { writeManifest } from './service-manifest.js'\nimport { pipe, mkdirp } from './util.js'\nimport { VITE_PLUGIN_NAME } from './const.js'\nimport { maybeDump } from './dump.js'\nimport { importDefaultRelative } from './import-relative.cjs'\nimport Svenchify from './svenchify.js'\n\nconst defaultPresets = ['svench/presets/vite']\n\nconst isSveltePlugin = x =>\n  (x && x.name === 'svelte') || /\\bvite-plugin-svelte\\b/.test(x.name)\n\nconst initSvench = async ({ options, routix }, { command }) => {\n  const {\n    manifest,\n    index: indexCfg,\n    manifestDir,\n    publicDir,\n    entryUrl,\n  } = options\n\n  const watch = command === 'serve'\n\n  const runManifest = async () => {\n    if (!manifest) return\n    await writeManifest(options)\n  }\n\n  const runIndex = async () => {\n    if (!indexCfg) return\n    await createIndex(indexCfg, {\n      watch,\n      script: entryUrl,\n      publicDir,\n    })\n  }\n\n  const startRoutix = async () => {\n    await mkdirp(manifestDir)\n    await routix.start({ watch })\n    await routix.onIdle(100) // report init errors\n  }\n\n  await Promise.all([runIndex(), runManifest(), startRoutix()])\n}\n\nconst createPlugin = parts => {\n  const {\n    options,\n    options: { enabled, svenchDir: root, port, dump, vite = {} },\n  } = parts\n\n  maybeDump('options', dump, options)\n\n  if (!enabled) {\n    return { name: `${VITE_PLUGIN_NAME}:disabled` }\n  }\n\n  let env\n\n  return {\n    name: VITE_PLUGIN_NAME,\n\n    config(config, _env) {\n      env = _env\n      return {\n        root,\n        ...vite,\n        server: {\n          port,\n          ...vite.server,\n        },\n        // TODO $svench alias?\n        // resolve: {\n        //   alias: {\n        //     $svench: entryFile,\n        //     ...(vite.resolve && vite.resolve.alias),\n        //   },\n        //   ...vite.resolve,\n        // },\n      }\n    },\n\n    configResolved(config) {\n      maybeDump('config', dump, config)\n    },\n\n    async options() {\n      await initSvench(parts, env)\n    },\n  }\n}\n\nconst svenchVitePlugin = pipe(\n  options => ({ presets: defaultPresets, ...options }),\n  createPluginParts,\n  createPlugin\n)\n\nexport default svenchVitePlugin\n\nexport const svenchify = Svenchify(\n  defaultPresets,\n  async (\n    { plugins: [...plugins] = [], ...config },\n    parts,\n    { wrapSvelteConfig }\n  ) => {\n    const {\n      options: {\n        defaultSveltePlugin,\n        sveltePlugin = defaultSveltePlugin,\n        svelte = {},\n        vite: { clearScreen = config.clearScreen, server } = {},\n      },\n    } = parts\n\n    const hasSveltePlugin = plugins.some(isSveltePlugin)\n    if (!hasSveltePlugin) {\n      Log.info('Inject svelte plugin: %s', sveltePlugin)\n      const plugin = await importDefaultRelative(sveltePlugin)\n      plugins.unshift(plugin(wrapSvelteConfig(svelte)))\n    }\n\n    const svenchPlugin = createPlugin(parts)\n    plugins.unshift(svenchPlugin)\n\n    return {\n      ...config,\n      plugins,\n      clearScreen,\n      server: {\n        ...config.server,\n        ...server,\n      },\n    }\n  },\n  getConfig => getConfig\n)\n"],"names":["writeManifest","createIndex","mkdirp","maybeDump","VITE_PLUGIN_NAME","pipe","createPluginParts","Svenchify","Log","importDefaultRelative"],"mappings":"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"}